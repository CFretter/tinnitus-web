<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/pico.min.css" />
<title>Tinnitus Reproduction</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
  }
  #sliders {
    margin-top: 20px;
  }
  .switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}
  /* Hide default HTML checkbox */
.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}


</style>
</head>
<body>
  <h1>Tinnitus Reproduction</h1>
  <button id="playButton">Play</button>
  <br><br>
  <div id="sideSelector">
    <input type="radio" name="side" value="left" id="left" checked="checked">
    <label for="l">left</label>
  </div>
  <div>
    <input type="radio" name="side" value="right" id="right">
    <label for="r">right</label>
  </div>
  <br>
  <label for="volumeSlider">Volume:</label>
  <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="0.5" style="width:85%">
  <span id="volumeLabel"></span>
  <br>
  <label for="frequencySlider">Frequency:</label>
  <input type="range" id="frequencySlider" min="1" max="3" step="0.01" value="1" style="width:85%">
  <span id="frequencyLabel">200 Hz</span>
  <br>
  <label for="bandwidthSlider">Bandwidth:</label>
  <input type="range" id="bandwidthSlider" min="1" max="500" step="1" value="100" style="width:85%">
  <span id="bandwidthLabel">100 Hz</span>
  </div>

  <script>
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let whiteNoise;
    let gainNode;
    let pannerNode;
    let volume=0.5;
    let bandpassFilter;
    let isPlaying = false;
    let side =false;

    function createWhiteNoiseBuffer() {
      let bufferSize = 4 * audioCtx.sampleRate;
      let noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      let output = noiseBuffer.getChannelData(0);

      for (let i = 0; i < bufferSize; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      return noiseBuffer;
    }

    function createBandpassFilter() {
      let filter = audioCtx.createBiquadFilter();
      filter.type = 'bandpass';
      filter.frequency.value = parseFloat(document.getElementById('bandwidthSlider').value); // default frequency
      let bandwidthValue = parseFloat(document.getElementById('bandwidthSlider').value);
      filter.Q.value = 10//filter.frequency.value / bandwidthValue; // default Q factor
      filter.gain.value=1
      return filter;
    }

    
    function updateFilterParams() {
      let fsliderpos=parseFloat(document.getElementById('frequencySlider').value);
      let frequencyValue= Math.pow(10,fsliderpos)*20;
      bandpassFilter.frequency.value = frequencyValue;
      let bandwidthValue = parseFloat(document.getElementById('bandwidthSlider').value);
      let nyquist = audioCtx.sampleRate / 2;
      let q=bandpassFilter.frequency.value *1.0 / bandwidthValue;
      bandpassFilter.Q.value = q;
      gainNode.gain.value = volume*q;
      
      // Update labels
      document.getElementById('frequencyLabel').textContent = frequencyValue.toFixed(1) + ' Hz';
      document.getElementById('bandwidthLabel').textContent = bandwidthValue + ' Hz';
      document.getElementById('volumeLabel').textContent = (volume*190).toFixed(1) + ' %';
    }

    function createAudioGraph() {
      whiteNoise = audioCtx.createBufferSource();
      whiteNoise.loop=true
      whiteNoise.buffer = createWhiteNoiseBuffer();

      bandpassFilter = createBandpassFilter();

      pannerNode = audioCtx.createPanner();
      pannerNode.setPosition(-1, 0, 0);//If you want it to play on the left channel
      gainNode = audioCtx.createGain();
      whiteNoise.connect(bandpassFilter).connect(pannerNode).connect(gainNode).connect(audioCtx.destination);
      updateFilterParams();
    }
    //initialise stuff
    createAudioGraph()
    // Event listeners
    document.getElementById('playButton').addEventListener('click', function() {
      if (!isPlaying) {
        createAudioGraph();
        whiteNoise.start();
        isPlaying = true;
        document.getElementById('playButton').textContent = 'Stop';
      } else {
        whiteNoise.stop();
        isPlaying = false;
        document.getElementById('playButton').textContent = 'Play';
      }
    });

    document.getElementById('left').addEventListener('input', function() {
     side=true;
    pannerNode.setPosition(-1, 0, 0);//If you want it to play on the left channel
    });
     document.getElementById('right').addEventListener('input', function() {
    side=false;
      pannerNode.setPosition(1, 0, 0);//If you want it to play on the left channel   
    });
    
    document.getElementById('volumeSlider').addEventListener('input', function() {
      volume=Math.exp(parseFloat(this.value*10))/50000;
      console.log(volume);
      updateFilterParams();
    });

    document.getElementById('frequencySlider').addEventListener('input', function() {
      updateFilterParams();
    });

    document.getElementById('bandwidthSlider').addEventListener('input', function() {
      updateFilterParams();
    });
    
  </script>
</body>
</html>
